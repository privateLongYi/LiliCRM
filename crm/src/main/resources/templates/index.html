<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>首页</title>
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" />
    <style>
        .baseMargin{
            margin: 5px 0 10px 0;
        }
        .baseColor{color: #1E9FFF}
        .list{cursor: pointer;height: 30px;padding: 5px;top: 0;line-height: 30px;}
        #list{border: 1px solid #C9C9C9; border-top: none;}
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">

    <!--头部固定区域-->
    <div class="layui-header">
        <div class="layui-logo">LiliCRM</div>
        <!--左侧导航-->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item">
                <input type="text" placeholder="请输入客户姓名/手机号" autocomplete="off" class="layui-input"
                       id="search" style="border: 0;background-color: #383d49;color: #bdbeb7;margin-top: 10px;">
                <input type="hidden" id="page" value="1">
                <input type="hidden" id="count">
                <div id="list" style="background-color: #383d49;height: auto; display: none;">
                    <div id="data"></div>
                    <div class='list' style='text-align: right;margin-top: -10px;'>
                        <i onclick="previousPage()" class="layui-icon layui-icon-up" style="font-size: 15px;"></i>&nbsp;&nbsp;&nbsp;
                        <i onclick="nextPage()" class="layui-icon layui-icon-down" style="font-size: 15px;"></i>
                    </div>
                    <div class='list' style='text-align: right;margin-top: -10px;' id='close'>
                        <i onclick="hideList()" class="layui-icon layui-icon-close" style="font-size: 15px;"></i>
                    </div>
                </div>
            </li>
        </ul>
        <!--右侧导航-->
        <ul class="layui-nav layui-layout-right" style="color: #FFFFFF;">
            <li class="layui-nav-item">
                <input type="hidden" id="uId" th:value="${user.getuId()}" >
                <input type="hidden" id="uName" th:value="${user.getuName()}" >
                <input type="hidden" id="uRoleId" th:value="${user.getuRoleId()}" >
                <input type="hidden" id="rName" th:value="${user.getrName()}" >
                <a href="javascript:;">
                    <img th:src="@{/images/head.jpg}" class="layui-nav-img">
                    <span id="username" th:text="${user.getuName()}"></span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:editPwd();">修改密码</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a th:href="@{/logout}">退出登录</a></li>
        </ul>
    </div>

    <!--左侧导航栏-->
    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree" lay-filter="test" id="nav">
                <li class="layui-nav-item layui-nav-itemed">
                    <a href="javascript:void(0);" id="workbench" class="skip">首页</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 内容主体区域 -->
    <div id="body" class="layui-body" style="background-color: #f5f5f5; bottom: 0px;">
        <iframe id="frame" frameborder="0" scrolling="yes" width="100%"
                src="workbench"></iframe>
    </div>

    <!--详情页面-->
    <div id="detail" style="position:absolute; z-index:999999; top:0; right:-100%;
		 transition:all linear 0.5s; width: 1050px; height: 648px;background-color:white;
		border: 1px gainsboro solid;box-shadow: gainsboro 0 0 5px 5px;margin-top: 2px;">

        <div style="float: left; margin: 5px;">
            <span style="font-size: 20px;">客户详情</span>
        </div>
        <div style="float: right; cursor: pointer;">
            <i onclick="javascript:document.getElementById('detail').style.right = '-100%';" class="layui-icon layui-icon-close" style="font-size: 25px;"></i>
        </div>
        <br>

        <!--head-->
        <div class="layui-row layui-card" style="height: 120px;">
            <div class="layui-col-md9 layui-row">
                <div class="layui-col-space1">
                    <!--客户信息-->
                    <br />
                    <div class="layui-col-md4 layui-row">
                        <div class="layui-col-space1">
                            <div class="layui-col-md3" style="padding-top: 10px;"><img id="img" th:src="@{/images/boy.png}" width="40px" height="40px" /></div>
                            <div class="layui-col-md7">
                                <div class="layui-row" style="margin-bottom: 2px;">
                                    <div class="layui-col-md6"><span style="font-size: 20px;" name="cName"></span></div>
                                    <div class="layui-col-md3"><span style="float: right;margin-top: 3px;" name="cAge"></span></div>岁
                                </div>
                                <div style="margin-bottom: 2px;"><span name="cTel"></span></div>
                                <div>上次:<span id="hName"></span></div>
                            </div>
                        </div>
                    </div>
                    <!--成交金额-->
                    <div class="layui-col-md2">
                        <br><div><span id="successMoney"></span></div>
                        <div><span style="color: #9F9F9F;">成交金额</span></div>
                    </div>
                    <!--已收金额-->
                    <div class="layui-col-md2">
                        <br><span id="payMoney"></span><br />
                        <span style="color: #9F9F9F;">已交金额</span>
                    </div>
                    <!--待收金额-->
                    <div class="layui-col-md2">
                        <br><span id="waitMoney"></span><br />
                        <span style="color: #9F9F9F;">待交金额</span>
                    </div>
                    <!--预交金额-->
                    <div class="layui-col-md2">
                        <br><span name="clEarnest"></span><br />
                        <span style="color: #9F9F9F;">预交金额</span>
                    </div>
                </div>
            </div>
            <br />
            <div class="layui-col-md3">
                <div style="margin-bottom: 2px;">创建时间:<span id="cTime"></span></div>
                <div style="margin-bottom: 2px;">修改时间:<span id="editTime"></span></div>
                <div>负责人:<span id="principal"></span></div>
            </div>
        </div>

        <!--body-->
        <div class="layui-row">
            <div class="layui-col-space10">
                <!--左侧选项卡、预约记录-->
                <div class="layui-col-md8">
                    <!--选项卡-->
                    <div class="layui-card" style="height: 255px;">
                        <div class="layui-tab">
                                <ul class="layui-tab-title">
                                    <li class="layui-this">基本信息</li>
                                    <li>操作记录</li>
                                    <li>成交记录</li>
                                </ul>
                                <div class="layui-tab-content">
                                    <!--基本信息-->
                                    <div class="layui-tab-item layui-show">
                                        <div class="layui-row" style="align-content: center;margin-left: 5px;">
                                            <div class="layui-col-md4 baseMargin">姓名：<span class="baseColor" name="cName"></span></div>
                                            <div class="layui-col-md4 baseMargin">性别：<span class="baseColor" id="cSex"></span></div>
                                            <div class="layui-col-md4 baseMargin">年龄：<span class="baseColor" name="cAge"></span></div>
                                            <div class="layui-col-md4 baseMargin">电话：<span class="baseColor" name="cTel"></span></div>
                                            <div class="layui-col-md4 baseMargin">来源：<span class="baseColor" id="clSource"></span></div>
                                            <div class="layui-col-md4 baseMargin">预交金额：<span class="baseColor" name="clEarnest"></span></div><br>
                                            <div class="layui-col-md4 baseMargin">报名项目：<span class="baseColor" id="clProject"></span></div>
                                            <div class="layui-col-md8 baseMargin">报名时间：<span class="baseColor" id="clPlaceTime"></span></div>
                                        </div>
                                    </div>
                                    <!--操作记录-->
                                    <div class="layui-tab-item" style="height: 190px;overflow-y: auto;">
                                        <ul class="layui-timeline" id="operating"></ul>
                                    </div>
                                    <!--成交记录-->
                                    <div class="layui-tab-item">
                                        <!--表格-->
                                        <table class="layui-hide" id="successTab" lay-filter="successTab"></table>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <!--预约记录-->
                    <div style="height: 223px;overflow-y: auto;">
                        <ul class="layui-timeline" id="appoint"></ul>
                    </div>
                </div>
                <!--右侧跟进-->
                <div class="layui-col-md4">
                    <div class="layui-card" style="height: 488px;overflow-y: auto;">
                        <!--表单-->
                        <div style="border:1px solid #f2f2f2;height: 280px;">
                            <div class="layui-form layui-form-item" style="margin: 15px 15px 0 15px;">
                                <div class="layui-input-inline layui-form">
                                    <input type="radio" name="followInput" value="1" title="门诊反馈" checked>
                                    <input type="radio" name="followInput" value="2" title="客户回访">
                                </div>
                                <br><br><br>
                                <input class="layui-input" id="fTime" autocomplete="off"
                                       placeholder="跟进时间" readonly>
                            </div>
                            <div class="layui-form-item layui-form-text" style="margin-top: 15px; margin-left: 15px; margin-right: 15px;">
                                <input type="hidden" id="cId">
                                <input type="hidden" id="clId">
                                <input type="hidden" id="clUId">
                                <textarea id="content" placeholder="请输入内容" class="layui-textarea" style="border-color: #FFFFFF;"></textarea>
                            </div>
                            <div class="layui-form-item" style="margin-top: 15px;text-align: center;">
                                <button class="layui-btn layui-btn-sm" onclick="saveFollow()">提交</button>
                                <button class="layui-btn layui-btn-sm layui-btn-primary" onclick="clean()">清空</button>
                            </div>
                        </div>
                        <!--跟进记录-->
                        <div style="margin-top: 20px;">
                            <ul class="layui-timeline" id="follow">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
<script src="//cdn.bootcdn.net/ajax/libs/layui/2.4.3/layui.all.min.js"></script>
<!--<script th:src="@{layui/layui.all.js}"></script>-->

<script>

    var $ = layui.jquery
        ,element = layui.element //Tab的切换功能，切换事件监听等，需要依赖element模块
        ,layer = layui.layer
        ,table = layui.table
        ,form = layui.form
        ,laydate = layui.laydate

    //获取用户编号和用户名
    var uId = $("#uId").val();
    var uName = $("#uName").val();
    var uRoleId = $("#uRoleId").val();
    var rName = $("#rName").val();

    //把用户编号和用户名存到sessionStorage
    sessionStorage.setItem('uId', uId);
    sessionStorage.setItem('uName', uName);
    sessionStorage.setItem('uRoleId', uRoleId);
    sessionStorage.setItem('rName', rName);

    //设置iframe框架高度
    $(document).ready(function(){
        var height = $(window).height(); //浏览器当前窗口可视区域高度
        if ((height-65) < 590){
            $("#frame").height(590);
        } else {
            $("#frame").height(height - 65);
        }
    })

    //根据客户名称或者客户电话查询客户
    function getList(search, page){
        if(search != ""){
            $.post("/customer/queryCByCNameOrCTel", {rName:rName, uId:uId, key:search, page:page}, function (data) {
                var html = "";
                for (i = 0; i < data.data.length; i++){
                    html += "<div class='list' onclick='goDetail(&quot;"+data.data[i].cId+"&quot;,&quot;"+data.data[i].clId+"&quot;,&quot;"+data.data[i].clUId+"&quot;);'>"+data.data[i].cName+"/"+data.data[i].cTel+"</div>";
                }
                //赋值
                $("#data").html(html);
                $("#count").val(data.count);
            });
            $("#list").attr("style", "background-color: #383d49;height: auto; display: block;");
        }else{
            //赋值
            $("#data").html("");
            $("#list").attr("style", "background-color: #383d49;height: auto; display: none;");
        }
    }

    //给搜索框添加input事件
    $("#search").on("input", function () {
        var search = $("#search").val();
        var page = $("#page").val();
        getList(search, page);
    });

    //给搜索框添加onfocus事件
    $("#search").on("focus", function(){
        var search = $("#search").val();
        if(search != ""){
            $("#list").attr("style", "background-color: #383d49;height: auto; display: block;");
        }
    });

    //上一页
    function previousPage() {
        //获取当前页码
        var page = $("#page").val();
        //获取总条数
        var count = $("#count").val();
        if (count != 0){
            if (eval(page+"-"+1) <= 0){
                layer.msg('已经是第一页');
            } else {
                var search = $("#search").val();
                getList(search, eval(page+"-"+1));
                //给页码赋值
                $("#page").val(eval(page+"-"+1));
            }
        } else {
            layer.msg('没有数据');
        }
    }

    //下一页
    function nextPage() {
        //获取当前页码
        var page = $("#page").val();
        //获取总条数
        var count = $("#count").val();
        if (count != 0){
            if (eval(page+"+"+1) > count){
                layer.msg('已经是最后一页');
            } else {
                var search = $("#search").val();
                getList(search, eval(page+"+"+1));
                //给页码赋值
                $("#page").val(eval(page+"+"+1));
            }
        } else {
            layer.msg('没有数据');
        }
    }

    //隐藏列表
    function hideList() {
        $("#list").attr("style", "background-color: #383d49;height: auto; display: none;");
    }

    //时间控件
    laydate.render({
        elem: '#fTime' //指定元素
        ,type: 'datetime' //时间格式
        ,trigger: 'click' //采用click弹出
        ,value: new Date() //默认时间
        ,btns: ['now', 'confirm'] //工具按钮
    });

    //新增跟进记录
    function saveFollow() {
        //客户编号
        var cId = $("#cId").val();
        //线索编号
        var clId = $("#clId").val();
        //负责人编号
        var clUId = $("#clUId").val();
        var fTypeId;
        var ftType;
        //跟进类型编号、跟进类型
        if ($("[name=followInput]")[0].checked){
            fTypeId = $("[name=followInput]")[0].value;
            ftType = $("[name=followInput]")[0].title;
        } else if ($("[name=followInput]")[1].checked){
            fTypeId = $("[name=followInput]")[1].value;
            ftType = $("[name=followInput]")[1].title;
        }
        //跟进内容
        var fContent = $("#content").val();
        if (fContent != "" && fContent != null && fContent.trim() != "" && fContent.trim() != null){
            //跟进时间
            var fTime = $("#fTime").val();
            //新增跟进内容
            $.post("/follow/saveFollow"
                ,{uId:uId, cId:cId, fClId:clId, fTypeId:fTypeId, clUId:clUId,
                    ftType:ftType, fContent:fContent, fTime: fTime}
                ,function (data) {
                    layer.msg(data.msg, {time: 500}, function () {
                        $("#content").val("");
                        var time = new Date();
                        var fTime = time.getFullYear()+"-"+eval(time.getMonth()+"+"+1)+"-"+
                            time.getDate()+" "+time.getHours()+":"+
                            time.getMinutes()+":"+time.getSeconds();
                        $("#fTime").val(fTime);
                        goDetail(cId, clId, clUId);
                    });
                }
            )
        } else {
            layer.msg("请填写跟进内容！")
        }
    }

    //清空跟进内容
    function clean() {
        $("#content").val("");
    }

    //弹出详情页面
    function goDetail(cId, clId, clUId) {

        //隐藏搜索
        $("#list").attr("style", "background-color: #383d49;height: auto; display: none;");

        //显示详情页面
        document.getElementById("detail").style.right = 0;
        document.getElementById("detail").style.display = "block";

        //赋值
        $("#cId").val(cId);
        $("#clId").val(clId);
        $("#clUId").val(clUId);

        //根据客户编号查询信息并赋值
        $.get("/customer/detail", {clId:clId}, function (data) {
            if (data.customer.cSex == "男"){
                $("#img").attr("src", "/images/boy.png");
            } else {
                $("#img").attr("src", "/images/boy.png");
            }
            //上次门诊
            $("#hName").text(data.hName);
            //给基本信息赋值
            var cNameList = $("[name=cName]");
            for(var i = 0; i < cNameList.length; i++){
                cNameList[i].innerText = data.customer.cName;
            }
            var cAgeList = $("[name=cAge]");
            for(var i = 0; i < cAgeList.length; i++){
                cAgeList[i].innerText = data.customer.cAge;
            }
            var cTelList = $("[name=cTel]");
            for(var i = 0; i < cTelList.length; i++){
                cTelList[i].innerText = data.customer.cTel;
            }
            var clEarnestList = $("[name=clEarnest]");
            for(var i = 0; i < clEarnestList.length; i++){
                clEarnestList[i].innerText = data.customer.clEarnest;
            }
            //成交金额
            $("#successMoney").text(data.successMoney);
            //已交金额
            $("#payMoney").text(data.payMoney);
            //待交金额
            $("#waitMoney").text(data.waitMoney);
            //创建时间
            $("#cTime").text(data.customer.cTime);
            //修改时间
            $("#editTime").text(data.updateTime);
            //负责人
            $("#principal").text(data.customer.uName);
            //性别
            $("#cSex").text(data.customer.cSex);
            //来源
            $("#clSource").text(data.customer.clSource);
            //报名项目
            $("#clProject").text(data.customer.clProject);
            //报名时间
            $("#clPlaceTime").text(data.customer.clPlaceTime);
        });

        //预约记录
        $.get("/appointment/queryAToDetail", {clId:clId}, function (data) {
            var html = "";
            $.each(data.data, function (index, item) {
                html += "<li class='layui-timeline-item'>" +
                            "<i class='layui-icon layui-timeline-axis'>&#xe63f;</i>" +
                            "<div class='layui-timeline-content layui-text'>" +
                                "<div class='layui-card' style='background-color: aliceblue;'>" +
                                    "<div><span style='font-size: 20px;'>"+item.aTime+"【"+item.aType+"】</span></div>" +
                                    "<div style='margin-top: 5px;'>预约项目："+item.clProject+"</div>" +
                                    "<div style='margin-top: 5px;'>预约人："+item.uName+"</div>" +
                                    "<div style='margin-top: 5px;'>预交金额："+item.clEarnest+"</div>" +
                                    "<div style='margin-top: 5px;'>" +
                                        "<div style='text-align: left'>预约门诊："+item.hName+"</div>" +
                                        "<div style='text-align: right'>创建时间："+item.aCreateTime+"</div>" +
                                    "</div"+
                                "</div>" +
                            "</div>" +
                        "</li>";
            });
            $("#appoint").html(html);
        });

        //操作记录
        $.get("/operating/queryOpByCId", {cId:cId}, function (data) {
            var html = "";
            $.each(data.data, function (index, item) {
                html += "<li class='layui-timeline-item'>" +
                    "<i class='layui-icon layui-timeline-axis'>&#xe63f;</i>" +
                    "<div class='layui-timeline-content layui-text'>" +
                    "<div class='layui-card' style='background-color: aliceblue;'>" +
                    "<div><span style='font-size: 20px;'>"+item.opTime+"</span></div>" +
                    "<div style='margin-top: 5px;'>操作用户："+item.uName+"</div>" +
                    "<div style='margin-top: 5px;'>操作名称："+item.opName+"</div>" +
                    "</div>" +
                    "</div>" +
                    "</li>";
            });
            $("#operating").html(html);
        });

        //成交记录
        table.render({
            elem: '#successTab'
            ,url: '/success/querySByClId?clId='+clId //访问路径
            ,height: '180px'
            ,page: true //开启分页
            ,limit: 2 //每页显示条数
            ,limits: [2] //自定义可选每页显示条数
            ,cols: [
                [
                    {field: 'sId', title: 'ID', minWidth: 120, sort: true}
                    ,{field: 'cName', title: '客户名称', minWidth: 120}
                    ,{field: 'cTel', title: '电话', minWidth: 120}
                    ,{field: 'hName', title: '成交门诊', minWidth: 150}
                    ,{field: 'sMessage', title: '成交信息', minWidth: 150}
                    ,{field: 'sSum', title: '成交金额', minWidth: 120, sort: true}
                    ,{field: 'sPaysum', title: '已交金额', minWidth: 120, sort: true}
                    ,{field: 'sRemark', title: '成交备注', minWidth: 250}
                    ,{field: 'sTime', title: '成交时间', minWidth: 200}
                ]
            ]
        });

        //根据客户编号查询所拥有的跟进类型
        $.get("/follow/queryFollowByFClId?clId="+clId, function(obj){
            var html = "";
            for(var i = 0; i < obj.length; i++) {
                var year = obj[i].time.substring(0, 4);
                var month = obj[i].time.substring(5, 7);
                var day = obj[i].time.substring(8, 10);
                var date = year+"年"+month+"月"+day+"日";
                html += "<li class='layui-timeline-item'>" +
                    "<i class='layui-icon layui-timeline-axis'>&#xe63f;</i>" +
                    "<div class='layui-timeline-content layui-text'>" +
                    "<h3>"+date+"("+obj[i].type+")</h3>" +
                    "<ul>";
                    for(var j = 0; j < obj[i].followList.length; j++){
                        html += "<li>"+obj[i].followList[j]+"</li>";
                    }
                html += "</ul>" +
                        "</div>" +
                        "</li>";
            }
            //赋值
            $("#follow").html(html);
        });
    }

    //跳转页面
    function skip(id) {
        $("#frame").attr("src", id);
    }

    //修改密码
    function editPwd() {
        var ix = layer.open({
            type: 2, //层类型，iframe
            title: '修改密码',
            content: ['/goEditPwd'],
            area: ['400px', '300px'],
            resize: false,
            btn: '确定',
            btn1: function (index, layero) {
                var body = layer.getChildFrame('body', index);
                //获取值
                var oldPwd = $(body).find("#oldPwd").val();
                var newPwd = $(body).find("#newPwd").val();
                var newPwd2 = $(body).find("#newPwd2").val();
                //判断当前密码是否输入正确
                $.post("/user/verifyPwd", {uId:uId, uPassword:oldPwd}, function (data) {
                    if (data){
                        if (newPwd.length >=6 && newPwd.length <=16 && newPwd2.length >=6 && newPwd2.length <=16){
                            if (newPwd == newPwd2){
                                $.post("/user/editPwd", {uId:uId, uPassword:newPwd}, function (data) {
                                    layer.close(ix);
                                    layer.msg("密码已修改，请重新登录", {time: 1000}, function () {
                                        location.href = "/loginPage";
                                    });
                                })
                            } else {
                                layer.msg("两次密码不一致");
                            }
                        } else {
                            layer.msg("密码长度为6到16个字符");
                        }
                    } else {
                        layer.msg("当前密码输入错误");
                    }
                })
            },
            cancel: function(index, layero){
                layer.close(index);
            }
        });
    }

    //获取菜单列表
    $.get("/authority/queryRMByRId?rId="+uRoleId, function (obj) {
        //定义内容
        var html = "";
        var parent = obj.data;
        var child = obj.data;
        for(index in parent){
            if(parent[index].mParentId == 0){
                html += "<li class='layui-nav-item layui-nav-itemed'>" +
                    "       <a class='' href='javascript:;'>"+parent[index].mName+"</a>" +
                    "       <dl class='layui-nav-child'>";
                for(i in child){
                    if(child[i].mParentId == parent[index].rmMId){
                        html += "<dd>" +
                            "   <a href='javascript:;' id='"+child[i].mUrl+"' class='skip'>"+child[i].mName+"</a>" +
                            "</dd>"
                    }
                }
                html += "   </dl>" +
                    "</li>";
            }
        }

        //给导航条赋值
        $("#nav").append(html);
        //重新渲染元素
        element.init();

        //绑定跳转事件
        $(".skip").on("click", function () {
            skip(this.id);
        })

    });

</script>
</body>
</html>