<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="layui/css/layui.css">
	</head>
	<body>

	<!-- 高级筛选 -->
	<br />
	<div>
		&nbsp;&nbsp;&nbsp;<button id="screen" type="button" class="layui-btn">高级筛选</button>
	</div>
	<br />

	<!-- 列出筛选条件 -->
	<div id="list">

	</div>

	<!-- 数据表格 -->
	<table class="layui-hide" id="tab" lay-filter="test" lay-data="{id: 'tab'}"></table>
 
		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
		  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
		  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
		</script>

		<script src="layui/layui.js"></script>

		<script>

            layui.use(['laydate', 'laypage', 'layer', 'table', 'upload', 'element'], function(){
                var laydate = layui.laydate //日期
                    ,laypage = layui.laypage //分页
                    ,layer = layui.layer //弹层
                    ,table = layui.table //表格
                    ,upload = layui.upload //上传
                    ,element = layui.element //元素操作
                    ,$ = layui.jquery //jQuery

                //筛选条件
                function screen(name, value, text){
                    //判断是否是报名时间
                    var condition;
                    if(name == "cPlaceTime"){
                        condition = "#beginTime";
					}else{
                        condition = "#"+name;
					}
                    //判断是否存在该条件
                    if($(condition).val() == undefined){
                        //新增节点
                        var div = document.createElement("div");
                        div.setAttribute('id', 'div'+name);
                        div.setAttribute('class', 'layui-input-inline');
                        var innerHTML = "<div class='layui-form-mid layui-word-aux'>"+
                            				"&nbsp;&nbsp;&nbsp;";
                        if(name == "cName"){
                            innerHTML += "姓名：";
                        }else if(name == "cTel"){
                            innerHTML += "电话：";
                        }else if(name == "cProject"){
                            innerHTML += "报名项目：";
                        }else if(name == "ctHospital"){
                            innerHTML += "预约门诊：";
                        }else if(name == "cEarnest"){
                            innerHTML += "是否交定金：";
                        }else if(name == "cSource"){
                            innerHTML += "来源：";
                        }else if(name == "cUId"){
                            innerHTML += "负责人：";
                        }else if(name == "cStatu"){
                            innerHTML += "状态：";
                        }else if(name == "cPlaceTime"){
                            innerHTML += "报名时间：";
                        }
                        if(name == "cPlaceTime"){
                            var beginTime = value.split(" - ")[0];
                            var endTime = value.split(" - ")[1];
                            innerHTML += "<span id='span"+name+"'>"+text.trim()+"</span>"+
                                "<input type='hidden' id='beginTime' value='"+beginTime+"'>"+
                                "<input type='hidden' id='endTime' value='"+endTime+"'>"+
                                "</div>"+
                                "<div class='layui-input-inline' style='cursor: pointer; padding: 10px 0px;'>"+
                                "<i class='layui-icon layui-icon-close' id='close"+name+"'></i>"+
                                "</div>";
                        }else{
                            innerHTML += "<span id='span"+name+"'>"+text.trim()+"</span>"+
                                "<input type='hidden' id='"+name+"' value='"+value.trim()+"'>"+
                                "</div>"+
                                "<div class='layui-input-inline' style='cursor: pointer; padding: 12px 0px;'>"+
                                "<i class='layui-icon layui-icon-close' id='close"+name+"'></i>"+
                                "</div>";
                        }
                        div.innerHTML = innerHTML;
                        document.getElementById("list").appendChild(div);
                        //关闭事件（移除节点）
                        $("#close"+name).click(function(){
                            list.removeChild(document.getElementById("div"+name));
                            //根据筛选条件查询客户
                            tableReload();
                        });
                    }else{
                        //改变已有的值
                        $("#span"+name).html(text.trim());
                        if(name != "cPlaceTime"){
							$("#"+name).val(value.trim());
                        }else{
                            var beginTime = value.split(" - ")[0];
                            var endTime = value.split(" - ")[1];
                            $("#beginTime").val(beginTime);
                            $("#endTime").val(endTime);
						}
                    }
                }

                //表格重载
				function tableReload(){

                    //获取筛选条件
                    var screenList = $("#list [type=hidden]");
                    //条件参数
                    var param = "";
                    for(var i = 0; i < screenList.length; i++){
						param += screenList[i].id + ":" + screenList[i].value + ",";
					}
					//根据筛选条件查询
                    table.reload('tab', {
                        url: 'customer/queryCScreen'
                        ,where: {
                            param: param
                        }
                    });

				}

				//弹出新增或修改页面
                function popup(index, url) {
                    var body = layer.getChildFrame('body', index);
                    //获取值
                    var cName = $(body).find("#cName").val();
                    var cSex = null;
                    if($(body).find("[name=cSex]")[0].checked){
                        cSex = $(body).find("[name=cSex]")[0].value;
                    }else{
                        cSex = $(body).find("[name=cSex]")[1].value;
                    }
                    var cAge = $(body).find("#cAge").val();
                    var cTel = $(body).find("#cTel").val();
                    var cProject = $(body).find("#cProject").val();
                    var cRemark = $(body).find("#cName").val();
                    var cEarnest = $(body).find("#cEarnest").val();
                    var cUId = $(body).find("#cUId").val();
                    var cSource = $(body).find("#cSource").val();
                    var cStatu = $(body).find("#cStatu").val();
                    if (cName != '' && cName.trim() != '' && cTel != '' && cTel.trim() != '') {
                        $.post(url, {cName:cName, cSex:cSex, cAge:cAge, cTel:cTel, cProject:cProject,
                                cRemark:cRemark, cEarnest:cEarnest, cUId:cUId, cSource:cSource, cStatu:cStatu},
                            function (obj) {
                                layer.msg(obj.msg, {time: 500}, function () {
                                    layer.closeAll();
                                    tableReload();
                                });
                            }
                        );
                    } else {
                        layer.msg('请输入带星号的必填项');
                    }
                }

                //执行一个 table 实例
                table.render({
                    elem: '#tab'
                    ,height: 360
                    ,url: 'customer/queryCScreen' //数据接口
                    ,title: '客户信息表' //表格名称
                    ,id: 'tab' //表格id
                    ,page: true //开启分页
                    ,limit: 5 //每页显示条数
                    ,limits: [5, 10, 20, 50, 100] //自定义可选每页显示条数
                    ,toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
                    ,cols: [ //表头
                        [
                            {type: 'checkbox', fixed: 'left'}
                            ,{field: 'cId', width: 120, title: 'ID', sort: true, align:'center'}
                            ,{field: 'cName', width: 120, title: '姓名', align:'center'}
                            ,{field: 'cSex', width: 120, title: '性别', sort: true, align:'center'}
                            ,{field: 'cAge', width: 120, title: '年龄', align:'center'}
                            ,{field: 'cTel', width: 120, title: '电话', align:'center'}
                            ,{field: 'cProject', width: 120, title: '报名项目', align:'center'}
                            ,{field: 'cPlaceTime', width: 200, title: '报名时间', align:'center'}
                            ,{field: 'ctHospital', width: 120, title: '预约门诊', align:'center'}
                            ,{field: 'cRemark', width: 120, title: '备注', align:'center'}
                            ,{field: 'cEarnest', width: 120, title: '定金', align:'center'}
                            ,{field: 'cUName', width: 120, title: '负责人', align:'center'}
                            ,{field: 'cSource', width: 120, title: '来源', align:'center'}
                            ,{field: 'cMessage', width: 120, title: '症状信息', align:'center'}
                            ,{field: 'cCallback', width: 120, title: '回访', align:'center'}
                            ,{field: 'cStatu', width: 120, title: '状态', align:'center'}
                            ,{fixed: 'right', width: 180, align:'center', toolbar: '#barDemo'}
                        ]
                    ]
                });

                //监听头工具栏事件
                table.on('toolbar(test)', function(obj){
                    var checkStatus = table.checkStatus(obj.config.id)
                        ,data = checkStatus.data; //获取选中的数据
                    switch(obj.event){
                        case 'add':
                            //弹出新增页面
                            layer.open({
                                type: 2, //层类型，iframe
                                title: '新增客户',
                                content: ['customersave'],
                                area: ['1000px', '420px'],
                                resize: false,
                                btn: '确定',
                                btn1: function (index, layero) {
                                    popup(index, "customer/saveCustomer");
                                },
                                cancel: function(layero,index){
                                    layer.closeAll();
                                }
                            });
                            break;
                        case 'update':
                            if(data.length === 0){
                                layer.msg('请选择一行');
                            } else if(data.length > 1){
                                layer.msg('只能同时编辑一个');
                            } else {
                                //弹出编辑页面
                                layer.open({
                                    type: 2, //层类型，iframe
                                    title: '编辑客户',
                                    content: ['customer/queryCByCId?cId=' + checkStatus.data[0].cId],
                                    area: ['1000px', '420px'],
                                    resize: false,
                                    btn: '确定',
                                    btn1: function (index, layero) {
                                        popup(index, "customer/editCByCId?cId=" + checkStatus.data[0].cId);
                                    },
                                    cancel: function(layero,index){
                                        layer.closeAll();
                                    }
                                });
                            }
                            break;
                        case 'delete':
                            if(data.length === 0){
                                layer.msg('请选择一行');
                            } else {
                                layer.confirm('真的删除行么', function(){
                                    $.get("customer/delCByCId?cId=" + checkStatus.data[0].cId, function(obj){
                                        if (obj.code == 0) {
                                            layer.msg(obj.msg, {time: 500}, function () {
                                                tableReload();
                                            });
                                        } else {
                                            layer.msg(obj.msg)
                                        }
                                    });
                                });
                            }
                            break;
                    }
                });

                //监听行工具事件
                table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
                    var data = obj.data //获得当前行数据
                        ,layEvent = obj.event; //获得 lay-event 对应的值
                    if(layEvent === 'del'){
                        layer.confirm('真的删除行么', function(index){
                            $.get("customer/delCByCId?cId=" + data.cId, function(obj){
                                if (obj.code == 0) {
                                    layer.msg(obj.msg, {time: 500}, function () {
                                        tableReload();
                                    });
                                } else {
                                    layer.msg(obj.msg)
                                }
                            });
                        });
                    } else if(layEvent === 'edit'){
						//弹出编辑页面
                        layer.open({
                            type: 2, //层类型，iframe
                            title: '编辑客户',
                            content: ['customer/queryCByCId?cId=' + data.cId],
                            area: ['1000px', '420px'],
                            resize: false,
                            btn: '确定',
                            btn1: function (index, layero) {
                                popup(index, "customer/editCByCId?cId=" + data.cId);
                            },
                            cancel: function(layero,index){
                                layer.closeAll();
                            }
                        });
                    } else if(layEvent === 'detail'){

						location.href = "customer/goDetail?cId=" + data.cId;

                    }

                });

                //弹出高级筛选列表
                $("#screen").click(function(){
                    layer.open({
                        type: 2, //层类型，iframe
                        title: '高级筛选',
                        content: ['screen'],
                        area: ['1000px', '420px'],
                        resize: false,
                        btn: '确定',
                        btn1: function(index, layero){
                            var body = layer.getChildFrame('body', index);
                            //获取筛选值
                            var cName = $(body).find("#cName").val().trim();
                            var cTel = $(body).find("#cTel").val().trim();
                            var cProject = $(body).find("#cProject").val();
                            var ctHospital = $(body).find("#ctHospital").val().trim();
                            //给是否交定金赋值
                            var cEarnest;
                            var cEarnestText;
                            if($(body).find("[name=cEarnest]")[0].checked){
                                cEarnest = $(body).find("[name=cEarnest]")[0].value;
                                cEarnestText = $(body).find("[name=cEarnest]")[0].title;
                            }
                            if($(body).find("[name=cEarnest]")[1].checked){
                                cEarnest = $(body).find("[name=cEarnest]")[1].value;
                                cEarnestText = $(body).find("[name=cEarnest]")[1].title;
                            }
                            var cUId = $(body).find("#cUId").val();
                            var cSource = $(body).find("#cSource").val().trim();
                            var cStatu = $(body).find("#cStatu").val();
                            var cPlaceTime = $(body).find("#cPlaceTime").val();
                            //新增筛选条件或者修改
                            if(cName != ''){
                                screen("cName", cName, cName);
                            }
                            if(cTel != ''){
                                screen("cTel", cTel, cTel);
                            }
                            if(cProject != ''){
                                var cProjectText = $(body).find("#cProject [value="+cProject+"]").text();
                                screen("cProject", cProject, cProjectText);
                            }
                            if(ctHospital != ''){
                                screen("ctHospital", ctHospital, ctHospital);
                            }
                            if(cEarnest != undefined){
                                screen("cEarnest", cEarnest, cEarnestText);
                            }
                            if(cUId != ''){
                                var cUIdText = $(body).find("#cUId [value="+cUId+"]").text();
                                screen("cUId", cUId, cUIdText);
                            }
                            if(cSource != ''){
                                screen("cSource", cSource, cSource);
                            }
                            if(cStatu != ''){
                                var cStatuText = $(body).find("#cStatu [value="+cStatu+"]").text();
                                screen("cStatu", cStatu, cStatuText);
                            }
                            if(cPlaceTime != ''){
                                screen("cPlaceTime", cPlaceTime, cPlaceTime);
                            }
                            //关闭弹出框
                            layer.closeAll();
                            //根据筛选条件查询客户
                            tableReload();
                        },
                        cancel: function(layero,index){
                            layer.closeAll();
                        }
                    });
                });

            });

		</script>

	</body>
</html>
