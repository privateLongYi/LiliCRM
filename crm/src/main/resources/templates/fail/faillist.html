<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>未成交客户列表</title>
		<link rel="stylesheet" th:href="@{/layui/css/layui.css}">
	</head>
	<body>

	<br>

	<div id="screen">
		&nbsp;&nbsp;&nbsp;根据姓名：
		<div class="layui-inline">
			<input class="layui-input" id="cName" autocomplete="off">
		</div>
		<button class="layui-btn search">查询</button>
		<button class="layui-btn" onclick="exportDataByScreen()">导出</button>
	</div>

	<!-- 数据表格 -->
	<table class="layui-hide" id="tab" lay-filter="test" lay-data="{id: 'tab'}"></table>

		<script type="text/html" id="toolbarDemo">
			<div class="layui-inline" lay-event="refresh"><i class="layui-icon layui-icon-refresh-1"></i></div>
		</script>

		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="feedback">门诊反馈</a>
			<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="callback">客户回访</a>
			<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="referral">转诊</a>
		</script>

		<script src="//cdn.bootcdn.net/ajax/libs/layui/2.4.3/layui.all.min.js"></script>

		<script th:src="@{/js/detail.js}"></script>


		<script>

            var layer = layui.layer //弹层
				,table = layui.table //表格
				,element = layui.element //元素操作
				,$ = layui.jquery //jQuery

			//从sessionStorage中获取用户编号和角色名称
			var uId = sessionStorage.getItem('uId');
			var rName = sessionStorage.getItem('rName');

			//为条件搜索按钮增加点击事件
			$(".search").on("click", function(data){
				tableReload();
			});

			//表格重载
			function tableReload(){
				//获取客户名称
				var cName = $("#cName").val();
				//根据客户名称查询
				table.reload('tab', {
					url: '/fail/queryFailByCName?uId='+uId+'&rName='+rName
					,where: {
						cName: cName
					}
					,page: {
						curr: 1 //重新从第 1 页开始
					}
				});
			}

            //导出数据
            function exportDataByScreen(){
                //获取姓名
                var cName = $("#cName").val();
                //根据筛选条件查询
                $.ajax({
                    url: '/fail/queryFailByCName?uId='+uId+'&rName='+
                    rName+'&cName='+cName+'&page=1&limit=10&export=1',
                    type: 'get',
                    async: false,
                    dataType: 'json',
                    success: function (res) {
                        //使用table.exportFile()导出数据
                        table.exportFile('tab', res.data, 'xls');
                    }
                });
            }

			//新增客户跟进
			function saveFollow(data, ftType){
				var ix = layer.open({
					type: 2, //层类型，iframe
					title: '新增客户跟进',
					content: ['/followsave?cId='+data.cId+'&clId='+data.clId+
                    '&clUId='+data.clUId+'&cName='+data.cName+'&ftType='+ftType],
					area: ['450px', '450px'],
					resize: false,
					btn: '确定',
					btn1: function (index, layero) {
						var body = layer.getChildFrame('body', index);
						//获取值
                        var cId = $(body).find("#cId").val();
						var fClId = $(body).find("#fClId").val();
                        var clUId = $(body).find("#clUId").val();
						var fTypeId = $(body).find("#fTypeId").val();
                        var fTime = $(body).find("#fTime").val();
						var fContent = $(body).find("#fContent").val();
						if (fContent != '' && fContent.trim() != '') {
							$.post("/follow/saveFollow", {uId:uId, cId:cId, fClId:fClId, fTime:fTime,
                                    clUId:clUId, fTypeId:fTypeId, ftType:ftType, fContent:fContent},
								function (obj) {
									layer.msg(obj.msg, {time: 500}, function () {
										layer.close(ix);
										tableReload();
									});
								}
							);
						} else {
							layer.msg('请输入门诊反馈内容');
						}
					},
					cancel: function(index, layero){
						layer.close(index);
					}
				});
			}

			//执行一个 table 实例
			table.render({
				elem: '#tab'
				,url: '/fail/queryFailByCName?uId='+uId+'&rName='+rName+'&export=0' //数据接口
				,title: '未成交客户' //表格名称
				,id: 'tab' //表格id
				,page: true //开启分页
				,limit: 10 //每页显示条数
				,limits: [10, 20, 50, 100] //自定义可选每页显示条数
				,toolbar: '#toolbarDemo' //刷新、增加工具栏
				,defaultToolbar: ['filter'] //筛选工具栏
				,cols: [ //表头
					[
                        {field: 'cName', minWidth: 120, title: '姓名', align:'center'
                            ,templet: '<div><a href="javascript:goDetail({{d.cId}}, {{d.clId}}, {{d.clUId}});" class="layui-table-link">{{d.cName}}</a></div>'
                        }
                        ,{field: 'hName', minWidth: 200, title: '门诊', align:'center'}
						,{field: 'flCause', minWidth: 200, title: '未成交原因', align:'center'}
						,{fixed: 'right', minWidth: 240, align:'center', toolbar: '#barDemo'}
					]
				]
			});

			//监听头工具栏事件
			table.on('toolbar(test)', function(obj){
				var checkStatus = table.checkStatus(obj.config.id)
					,data = checkStatus.data; //获取选中的数据
				switch(obj.event){
					case 'refresh':
						tableReload();
						break;
				}
			});

			//监听行工具事件
			table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
				var data = obj.data //获得当前行数据
					,layEvent = obj.event; //获得 lay-event 对应的值
				if(layEvent === 'feedback'){
					saveFollow(data, "门诊反馈");
				} else if(layEvent === 'callback'){
					saveFollow(data, "客户回访");
				} else if(layEvent === 'referral'){
					//弹出转诊页面
					var ix = layer.open({
						type: 2, //层类型，iframe
						title: '新增转诊记录',
						content: ['/referralsave?cId='+data.cId+'&clId='+data.clId+'&rAId='+data.flAId+'&flId='+data.flId+
                        '&clUId='+data.clUId+'&cName='+data.cName+'&hId='+data.hId+'&hName='+data.hName],
						area: ['450px', '450px'],
						resize: false,
						btn: '确定',
						btn1: function (index, layero) {
							var body = layer.getChildFrame('body', index);
							//获取值
							var cId = $(body).find("#cId").val();
                            var clId = $(body).find("#clId").val();
                            var rAId = $(body).find("#rAId").val();
                            var clUId = $(body).find("#clUId").val();
                            var flId = $(body).find("#flId").val();
							var rFailHId = $(body).find("#rFailHId").val();
							var rHId = $(body).find("#rHId").val();
							var aTime = $(body).find("#aTime").val();
							var rMessage = $(body).find("#rMessage").val();
							var rCause = $(body).find("#rCause").val();
							if (rMessage != '' && rMessage.trim() != '' && rCause != '' && rCause.trim() != '') {
								$.post("/referral/saveReferral",
									{uId:uId, cId:cId, clId:clId, clUId:clUId, rAId:rAId, flId:flId,
										rFailHId:rFailHId, aTime:aTime, rHId:rHId,
										rMessage:rMessage, rCause:rCause},
									function (obj) {
										layer.msg(obj.msg, {time: 500}, function () {
											layer.close(ix);
											tableReload();
										});
									}
								);
							} else {
								layer.msg('请填写带星号的必填项');
							}
						},
						cancel: function(index, layero){
							layer.close(index);
						}
					});
				}
			});

		</script>

	</body>
</html>
