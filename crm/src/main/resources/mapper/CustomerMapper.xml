<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linxi.mapper.CustomerMapper">

  <resultMap id="BaseResultMap" type="com.linxi.entity.Customer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 20 21:32:10 CST 2020.
    -->
    <id column="c_id" jdbcType="INTEGER" property="cId" />
    <result column="c_name" jdbcType="VARCHAR" property="cName" />
    <result column="c_sex" jdbcType="VARCHAR" property="cSex" />
    <result column="c_age" jdbcType="INTEGER" property="cAge" />
    <result column="c_tel" jdbcType="VARCHAR" property="cTel" />
    <result column="c_project" jdbcType="VARCHAR" property="cProject" />
    <result column="c_place_time" jdbcType="TIMESTAMP" property="cPlaceTime" />
    <result column="c_earnest" jdbcType="INTEGER" property="cEarnest" />
    <result column="c_u_id" jdbcType="INTEGER" property="cUId" />
    <result column="c_source" jdbcType="VARCHAR" property="cSource" />
    <result column="c_type_id" jdbcType="INTEGER" property="cTypeId" />
    <result column="c_remark" jdbcType="LONGVARCHAR" property="cRemark" />
    <result column="c_message" jdbcType="LONGVARCHAR" property="cMessage" />
  </resultMap>

  <!-- 高级筛选加分页查询客户 -->
  <select id="queryCScreen" resultMap="BaseResultMap">
    SELECT c.*, u.u_name AS uName, ct.ct_type AS cType FROM customer c
    LEFT JOIN `user` u ON c.c_u_id=u.u_id
    LEFT JOIN ctype ct ON c.c_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员'">
        AND c.c_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="cProject != null and cProject != ''">
        AND c.c_project = #{cProject}
      </if>
      <if test="cEarnest != null and cEarnest == 0">
        AND c.c_earnest = 0
      </if>
      <if test="cEarnest != null and cEarnest == 1">
        AND c.c_earnest != 0
      </if>
      <if test="beginTime != null or endTime != null">
        AND <![CDATA[  c_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  c_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="cUId != null">
        AND c.c_u_id = #{cUId}
      </if>
      <if test="cSource != null and cSource != ''">
        AND c.c_source = #{cSource}
      </if>
      <if test="cTypeId != null">
        AND c.c_type_id = #{cTypeId}
      </if>
    </where>
    ORDER BY c_place_time DESC
    limit #{page}, #{limit}
  </select>

  <!-- 根据筛选条件查询客户总数 -->
  <select id="getTotalByScreen" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN `user` u ON c.c_u_id=u.u_id
    LEFT JOIN ctype ct ON c.c_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员'">
        AND c.c_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="cProject != null and cProject != ''">
        AND c.c_project = #{cProject}
      </if>
      <if test="cEarnest != null and cEarnest == 0">
        AND c.c_earnest = 0
      </if>
      <if test="cEarnest != null and cEarnest == 1">
        AND c.c_earnest != 0
      </if>
      <if test="beginTime != null or endTime != null">
        AND <![CDATA[  c_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  c_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="cUId != null">
        AND c.c_u_id = #{cUId}
      </if>
      <if test="cSource != null and cSource != ''">
        AND c.c_source = #{cSource}
      </if>
      <if test="cTypeId != null">
        AND c.c_type_id = #{cTypeId}
      </if>
    </where>
  </select>

  <!-- 根据客户类型 获得客户总数量 -->
  <select id="getTotalByType" resultType="Integer">
    SELECT COUNT(*) FROM customer  where c_type_id=#{cTypeId}
  </select>

  <!-- 新增客户 -->
  <insert id="saveCustomer">
    INSERT INTO customer(c_name, c_sex, c_age, c_tel, c_project, c_place_time,
    c_earnest, c_u_id, c_source, c_remark, c_message, c_type_id)
    VALUES (#{cName}, #{cSex}, #{cAge}, #{cTel}, #{cProject}, NOW(), #{cEarnest},
    #{cUId}, #{cSource}, #{cRemark}, #{cMessage}, #{cTypeId})
  </insert>

  <!-- 根据编号删除客户 -->
  <delete id="delCByCId">
    DELETE FROM customer WHERE c_id = #{cId}
  </delete>

  <!-- 根据编号查看客户 -->
  <select id="queryCByCId" resultMap="BaseResultMap">
    SELECT c.*, ct.ct_type AS cType FROM customer c
    LEFT JOIN ctype ct ON c.c_type_id = ct_id WHERE c.c_id = #{cId}
  </select>

  <!-- 根据编号编辑客户 -->
  <update id="editCByCId">
    UPDATE customer SET c_name = #{cName}, c_sex = #{cSex}, c_age = #{cAge},
    c_tel = #{cTel}, c_project = #{cProject}, c_earnest = #{cEarnest},
    c_u_id = #{cUId}, c_source = #{cSource}, c_remark = #{cRemark},
    c_message = #{cMessage}, c_type_id = #{cTypeId}
    WHERE c_id = #{cId}
  </update>

  <!-- 根据编号编辑客户状态 -->
  <update id="editCTypeIdByCId">
    UPDATE customer SET c_type_id = #{cTypeId} WHERE c_id = #{cId}
  </update>

  <!-- 高级筛选加分页查询各种状态的客户 -->
  <select id="queryCScreenByCTypeId" resultMap="BaseResultMap">
    SELECT c.*, u.u_name AS uName, ct.ct_type AS cType,
    h.h_id AS hId, h.h_name AS hName, a.a_time AS aTime FROM customer c
    LEFT JOIN `user` u ON c.c_u_id=u.u_id
    LEFT JOIN ctype ct ON c.c_type_id=ct.ct_id
    LEFT JOIN appointment a ON c.c_id=a.a_c_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    <where>
      <if test="rName != '管理员'">
        AND c.c_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="cProject != null and cProject != ''">
        AND c.c_project = #{cProject}
      </if>
      <if test="cEarnest != null and cEarnest == 0">
        AND c.c_earnest = 0
      </if>
      <if test="cEarnest != null and cEarnest == 1">
        AND c.c_earnest != 0
      </if>
      <if test="beginTime != null or endTime != null">
        AND <![CDATA[  c_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  c_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="cUId != null">
        AND c.c_u_id = #{cUId}
      </if>
      <if test="cSource != null and cSource != ''">
        AND c.c_source = #{cSource}
      </if>
        AND ct.ct_id = #{cTypeId}
        AND a.a_time = (SELECT MAX(a_time) FROM appointment WHERE a_c_id = c.c_id)
    </where>
    ORDER BY c_place_time DESC
    limit #{page}, #{limit}
  </select>

  <!-- 根据筛选条件查询各种状态的客户总数 -->
  <select id="getTotalCScreenByCTypeId" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN `user` u ON c.c_u_id=u.u_id
    LEFT JOIN ctype ct ON c.c_type_id=ct.ct_id
    LEFT JOIN appointment a ON c.c_id=a.a_c_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    <where>
      <if test="rName != '管理员'">
        AND c.c_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="cProject != null and cProject != ''">
        AND c.c_project = #{cProject}
      </if>
      <if test="cEarnest != null and cEarnest == 0">
        AND c.c_earnest = 0
      </if>
      <if test="cEarnest != null and cEarnest == 1">
        AND c.c_earnest != 0
      </if>
      <if test="beginTime != null or endTime != null">
        AND <![CDATA[  c_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  c_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="cUId != null">
        AND c.c_u_id = #{cUId}
      </if>
      <if test="cSource != null and cSource != ''">
        AND c.c_source = #{cSource}
      </if>
      <if test="cTypeId != null">
        AND ct.ct_id = #{cTypeId}
      </if>
        AND a.a_time = (SELECT MAX(a_time) FROM appointment WHERE a_c_id = c.c_id)
    </where>
  </select>

  <!--根据用户编号和状态查询客户总条数-->
  <select id="getTotalCByUIdAndCTypeId" resultType="Integer">
    SELECT COUNT(*) FROM customer
    <where>
      c_u_id = #{uId}
      <if test="cTypeId != null">
        AND c_type_id = #{cTypeId}
      </if>
    </where>
  </select>

</mapper>