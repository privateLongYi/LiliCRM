<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linxi.mapper.CustomerMapper">

  <resultMap id="BaseResultMap" type="com.linxi.entity.Customer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 20 21:32:10 CST 2020.
    -->
    <id column="c_id" jdbcType="INTEGER" property="cId" />
    <result column="c_name" jdbcType="VARCHAR" property="cName" />
    <result column="c_sex" jdbcType="VARCHAR" property="cSex" />
    <result column="c_age" jdbcType="INTEGER" property="cAge" />
    <result column="c_tel" jdbcType="VARCHAR" property="cTel" />
    <result column="c_time" jdbcType="TIMESTAMP" property="cTime" />
  </resultMap>

  <!-- 高级筛选加分页查询客户 -->
  <select id="queryCScreen" resultMap="BaseResultMap">
    SELECT c.*, cl.cl_id AS clId, cl.cl_project AS clProject, cl.cl_place_time AS clPlaceTime,
    cl.cl_remark AS clRemark, cl.cl_entry_fee AS clEntryFee,
    u.u_name AS uName, cl.cl_source AS clSource,
    cl.cl_message AS clMessage, ct.ct_type AS cType,
    u.u_id AS clUId FROM customer c
    LEFT JOIN clue cl ON c.c_id=cl.cl_c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN ctype ct ON cl.cl_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="clProject != null and clProject != ''">
        AND cl.cl_project = #{clProject}
      </if>
      <if test="clEntryFee != null and clEntryFee == '0'">
        AND (cl.cl_earnest = 0 OR cl.cl_earnest IS NULL)
      </if>
      <if test="clEntryFee != null and clEntryFee == '1'">
        AND cl.cl_earnest != 0
      </if>
      <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
        AND <![CDATA[  cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  cl_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="clUId != null">
        AND cl.cl_u_id = #{clUId}
      </if>
      <if test="clSource != null and clSource != ''">
        AND cl.cl_source = #{clSource}
      </if>
      <if test="clTypeId != null">
        AND cl.cl_type_id = #{clTypeId}
      </if>
      AND cl.cl_invalid = 0
    </where>
    ORDER BY cl_place_time DESC
    <if test="export == 0">
      limit #{page}, #{limit}
    </if>
  </select>

  <!-- 根据筛选条件查询客户总数 -->
  <select id="getTotalByScreen" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON c.c_id=cl.cl_c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN ctype ct ON cl.cl_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="clProject != null and clProject != ''">
        AND cl.cl_project = #{clProject}
      </if>
      <if test="clEntryFee != null and clEntryFee == '0'">
        AND (cl.cl_earnest = 0 OR cl.cl_earnest IS NULL)
      </if>
      <if test="clEntryFee != null and clEntryFee == '1'">
        AND cl.cl_earnest != 0
      </if>
      <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
        AND <![CDATA[  cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  cl_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="clUId != null">
        AND cl.cl_u_id = #{clUId}
      </if>
      <if test="clSource != null and clSource != ''">
        AND cl.cl_source = #{clSource}
      </if>
      <if test="clTypeId != null">
        AND cl.cl_type_id = #{clTypeId}
      </if>
      AND cl.cl_invalid = 0
    </where>
  </select>

  <!-- 高级筛选加分页查询客户 -->
  <select id="queryAACScreen" resultMap="BaseResultMap">
    SELECT c.*, cl.cl_id AS clId, cl.cl_project AS clProject, cl.cl_place_time AS clPlaceTime,
    cl.cl_remark AS clRemark, cl.cl_entry_fee AS clEntryFee,
    u.u_name AS uName, cl.cl_source AS clSource,
    cl.cl_message AS clMessage, ct.ct_type AS cType, a.a_id AS aId, h.h_id AS hId, h.h_name AS hName,
    a.a_time AS aTime, u.u_id AS clUId FROM customer c
    LEFT JOIN clue cl ON c.c_id=cl.cl_c_id
    LEFT JOIN appointment a ON a.a_cl_id=cl.cl_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN ctype ct ON cl.cl_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="clProject != null and clProject != ''">
        AND cl.cl_project = #{clProject}
      </if>
      <if test="clEntryFee != null and clEntryFee == '0'">
        AND (cl.cl_earnest = 0 OR cl.cl_earnest IS NULL)
      </if>
      <if test="clEntryFee != null and clEntryFee == '1'">
        AND cl.cl_earnest != 0
      </if>
      <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
        AND <![CDATA[  a.a_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  a.a_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="clUId != null">
        AND cl.cl_u_id = #{clUId}
      </if>
      <if test="clSource != null and clSource != ''">
        AND cl.cl_source = #{clSource}
      </if>
      <if test="clTypeId != null">
        AND cl.cl_type_id = #{clTypeId}
      </if>
      AND cl.cl_invalid = 0 AND a.a_status = 0
    </where>
    ORDER BY a.a_time DESC
    <if test="export == 0">
      limit #{page}, #{limit}
    </if>
  </select>

  <!-- 根据筛选条件查询客户总数 -->
  <select id="getAACTotalByScreen" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON c.c_id=cl.cl_c_id
    LEFT JOIN appointment a ON a.a_cl_id=cl.cl_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN ctype ct ON cl.cl_type_id=ct.ct_id
    <where>
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="cName != null and cName != ''">
        AND c.c_name LIKE '%${cName}%'
      </if>
      <if test="cTel != null and cTel != ''">
        AND c.c_tel = #{cTel}
      </if>
      <if test="clProject != null and clProject != ''">
        AND cl.cl_project = #{clProject}
      </if>
      <if test="clEntryFee != null and clEntryFee == '0'">
        AND (cl.cl_earnest = 0 OR cl.cl_earnest IS NULL)
      </if>
      <if test="clEntryFee != null and clEntryFee == '1'">
        AND cl.cl_earnest != 0
      </if>
      <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
        AND <![CDATA[  cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H') ]]>
        AND <![CDATA[  cl_place_time <= DATE_FORMAT(#{endTime}, '%Y-%m-%d %H') ]]>
      </if>
      <if test="clUId != null">
        AND cl.cl_u_id = #{clUId}
      </if>
      <if test="clSource != null and clSource != ''">
        AND cl.cl_source = #{clSource}
      </if>
      <if test="clTypeId != null">
        AND cl.cl_type_id = #{clTypeId}
      </if>
      AND cl.cl_invalid = 0 AND a.a_status = 0
    </where>
  </select>

  <!-- 新增客户 -->
  <insert id="saveCustomer">
    INSERT INTO customer(c_name, c_sex, c_age, c_tel, c_time)
    VALUES (#{cName}, #{cSex}, #{cAge}, #{cTel}, NOW())
  </insert>

  <!--查询最大的编号（新增客户的编号）-->
  <select id="queryMaxCId" resultType="Integer">
    SELECT MAX(c_id) FROM customer
  </select>

  <!-- 根据编号删除客户 -->
  <delete id="delCByCId">
    DELETE FROM customer WHERE c_id = #{cId}
  </delete>

  <!-- 根据客户编号查看客户 -->
  <select id="queryCByCId" resultMap="BaseResultMap">
    SELECT c.*, cl.cl_project AS clProject, cl.cl_place_time AS clPlaceTime,
    cl.cl_remark AS clRemark, cl.cl_entry_fee AS clEntryFee, cl_u_id AS clUId,
    cl.cl_source AS clSource, cl.cl_message AS clMessage, u.u_name AS uName,
    ct.ct_type AS cType, cl.cl_type_id AS clTypeId FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN ctype ct ON cl.cl_type_id = ct_id
    LEFT JOIN user u ON cl.cl_u_id = u.u_id WHERE c.c_id = #{cId}
    AND cl.cl_invalid = 0
  </select>

  <!-- 根据线索编号查看客户 -->
  <select id="queryCByClId" resultMap="BaseResultMap">
    SELECT c.*, cl.cl_project AS clProject, cl.cl_place_time AS clPlaceTime,
    cl.cl_remark AS clRemark, cl.cl_entry_fee AS clEntryFee, cl_u_id AS clUId,
    cl.cl_source AS clSource, cl.cl_message AS clMessage, u.u_name AS uName,
    ct.ct_type AS cType, cl.cl_type_id AS clTypeId FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN ctype ct ON cl.cl_type_id = ct_id
    LEFT JOIN user u ON cl.cl_u_id = u.u_id WHERE cl.cl_id = #{clId}
    AND cl.cl_invalid = 0
  </select>

  <!-- 根据编号编辑客户 -->
  <update id="editCByCId">
    UPDATE customer SET c_name = #{cName}, c_sex = #{cSex}, c_age = #{cAge},
    c_tel = #{cTel} WHERE c_id = #{cId}
  </update>

  <!--根据用户编号和状态查询客户总条数-->
  <select id="getTotalCByUIdAndCTypeId" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      cl_u_id = #{uId}
      <if test="clTypeId != null">
        AND cl_type_id = #{clTypeId}
      </if>
      AND cl.cl_invalid = 0
    </where>
  </select>

  <!--根据客户名称或者客户电话查询客户-->
  <select id="queryCByCNameOrCTel" resultMap="BaseResultMap">
    SELECT c.c_id, cl.cl_id AS clId, c.c_name, c.c_tel, cl.cl_u_id AS clUId
    FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      (c_name LIKE '%${key}%' OR c_tel LIKE '%${key}%')
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
    </where>
    limit #{page}, 4
  </select>

  <!--根据客户名称或者客户电话查询客户-->
  <select id="getTotalByCNameOrCTel" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      (c_name LIKE '%${key}%' OR c_tel LIKE '%${key}%')
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
    </where>
  </select>

  <!--根据用户编号和客户名称查询可成交客户-->
  <select id="queryCSCByUIdAndCName" resultMap="BaseResultMap">
    SELECT c.c_id, c.c_name, h.h_id AS hId, h.h_name AS hName,
    cl.cl_id AS clId, a.a_id AS aId FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN appointment a ON cl.cl_id=a.a_cl_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    <where>
      c.c_name LIKE '%${cName}%'
      AND (cl.cl_type_id = 4 OR cl.cl_type_id = 7)
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0 AND (a.a_status = 0 OR a.a_status = 2)
    </where>
    limit #{page}, 4
  </select>

  <!--根据用户编号和客户名称查询可成交客户总条数-->
  <select id="getTotalCSCByUIdAndCName" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    LEFT JOIN appointment a ON cl.cl_id=a.a_cl_id
    LEFT JOIN hospital h ON a.a_h_id=h.h_id
    <where>
      c.c_name LIKE '%${cName}%'
      AND (cl.cl_type_id = 4 OR cl.cl_type_id = 7)
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0 AND (a.a_status = 0 OR a.a_status = 2)
    </where>
  </select>

  <!--根据用户编号和客户名称查询可预约客户-->
  <select id="queryCACByUIdAndCName" resultMap="BaseResultMap">
    SELECT cl.cl_id AS clId, c.c_name FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    <where>
      c.c_name LIKE '%${cName}%'
      AND cl.cl_type_id = 3
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
    </where>
    limit #{page}, 4
  </select>

  <!--根据用户编号和客户名称查询可预约客户总条数-->
  <select id="getTotalCACByUIdAndCName" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    LEFT JOIN `user` u ON cl.cl_u_id=u.u_id
    <where>
      c.c_name LIKE '%${cName}%'
      AND cl.cl_type_id = 3
      <if test="rName != '管理员' and rName != '管理者'">
        AND cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
    </where>
  </select>

  <!--根据用户编号和起始时间和客户状态查询客户数量-->
  <select id="queryCByUIdAndTimeAndCTypeId" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      cl.cl_invalid = 0 AND cl.cl_type_id = #{clTypeId}
      <if test="rName == '销售员'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="beginTime != null and endTime != null">
        AND <![CDATA[  cl.cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
        AND <![CDATA[  cl.cl_place_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
      </if>
    </where>
  </select>

  <!--根据用户编号和起始时间查询客户-->
  <select id="queryCByTime" resultMap="BaseResultMap">
    SELECT c.c_name, c.c_tel, cl.cl_project AS clProject, cl.cl_place_time AS clPlaceTime,
    cl.cl_entry_fee AS clEntryFee, cl.cl_message AS clMessage FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      cl.cl_invalid = 0
      <if test="rName == '销售员'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="beginTime != null and endTime != null">
        AND <![CDATA[  cl.cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
        AND <![CDATA[  cl.cl_place_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
      </if>
    </where>
    limit #{page}, #{limit}
  </select>

  <!--根据用户编号和起始时间查询客户数量-->
  <select id="getTotalByTime" resultType="Integer">
    SELECT COUNT(*) FROM customer c
    LEFT JOIN clue cl ON cl.cl_c_id=c.c_id
    <where>
      cl.cl_invalid = 0
      <if test="rName == '销售员'">
        AND cl.cl_u_id = #{uId}
      </if>
      <if test="beginTime != null and endTime != null">
        AND <![CDATA[  cl.cl_place_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
        AND <![CDATA[  cl.cl_place_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
      </if>
    </where>
  </select>

  <!--根据用户编号和起始时间查询预约-->
  <select id="queryAByTime" resultMap="BaseResultMap">
    SELECT c.c_name AS cName, c.c_tel AS cTel, h.h_name AS hName, a.a_time AS aTime
    FROM appointment a
    INNER JOIN clue cl ON cl.cl_id=a.a_cl_id
    INNER JOIN customer c ON c.c_id=cl.cl_c_id
    INNER JOIN hospital h ON h.h_id=a.a_h_id
    <where>
      <if test="rName == '销售员'">
        cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
      AND <![CDATA[  a.a_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
      AND <![CDATA[  a.a_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
    </where>
    limit #{page}, #{limit}
  </select>

  <!--根据用户编号和起始时间查询预约客户数量-->
  <select id="getTotalAByTime" resultType="Integer">
    SELECT COUNT(*) FROM appointment a
    INNER JOIN clue cl ON cl.cl_id=a.a_cl_id
    INNER JOIN customer c ON c.c_id=cl.cl_c_id
    INNER JOIN hospital h ON h.h_id=a.a_h_id
    <where>
      <if test="rName == '销售员'">
        cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
      AND <![CDATA[  a.a_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
      AND <![CDATA[  a.a_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
    </where>
  </select>

  <!--根据姓名和电话查询客户-->
  <select id="queryCByCNameAndCTel" resultMap="BaseResultMap">
    SELECT * FROM customer WHERE c_name = #{cName} AND c_tel = #{cTel}
  </select>

  <!--根据用户编号和起始时间查询预约-->
  <select id="queryArriveByTime" resultMap="BaseResultMap">
    SELECT c.c_name AS cName, c.c_tel AS cTel, h.h_name AS hName, a.a_time AS aTime,
    ct.ct_type AS cType FROM appointment a
    INNER JOIN clue cl ON cl.cl_id=a.a_cl_id
    INNER JOIN customer c ON c.c_id=cl.cl_c_id
    INNER JOIN hospital h ON h.h_id=a.a_h_id
    INNER JOIN ctype ct ON ct.ct_id=cl.cl_type_id
    <where>
      <if test="rName == '销售员'">
        cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
      AND (cl.cl_type_id = 6 OR cl.cl_type_id = 7)
      AND <![CDATA[  a.a_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
      AND <![CDATA[  a.a_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
    </where>
    limit #{page}, #{limit}
  </select>

  <!--根据用户编号和起始时间查询预约客户数量-->
  <select id="getTotalArriveByTime" resultType="Integer">
    SELECT COUNT(*) FROM appointment a
    INNER JOIN clue cl ON cl.cl_id=a.a_cl_id
    INNER JOIN customer c ON c.c_id=cl.cl_c_id
    INNER JOIN hospital h ON h.h_id=a.a_h_id
    INNER JOIN ctype ct ON ct.ct_id=cl.cl_type_id
    <where>
      <if test="rName == '销售员'">
        cl.cl_u_id = #{uId}
      </if>
      AND cl.cl_invalid = 0
      AND (cl.cl_type_id = 6 OR cl.cl_type_id = 7)
      AND <![CDATA[  a.a_time >= DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
      AND <![CDATA[  a.a_time <= DATE_ADD(DATE_FORMAT(#{endTime}, '%Y-%m-%d'),INTERVAL 1 DAY) ]]>
    </where>
  </select>

</mapper>